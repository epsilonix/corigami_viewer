<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>C.Origami Viewer</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  {% if screening_mode %}
    <script>
      var screening_mode = true;
      var screening_params = {{ screening_params|safe }};
    </script>
  {% else %}
    <script>
      var screening_mode = false;
    </script>
  {% endif %}
  <!-- Load D3.js and our custom plotting script -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="{{ url_for('static', filename='d3_plots.js') }}"></script>
  
  <style>
    input[readonly] {
      background-color: #e0e0e0;
      color: #555;
      cursor: not-allowed;
    }
  </style>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

</head>
<body>
  <div class="container">
    <div class="form-container">
      <div class="form-header">
        <h1>C.ORIGAMI VIEWER</h1>
        <p class="instructions-link"><a href="#" id="openModal">Instructions</a></p>
      </div>
      <div id="instructions-modal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <!-- Links to paper and GitHub -->
          <div class="modal-header">
            For more information on C.Origami, 
            <a href="https://www.nature.com/articles/s41587-022-01612-8" target="_blank">read the paper</a> or visit the 
            <a href="https://github.com/tanjimin/C.Origami" target="_blank">GitHub repository</a>.
          </div>
      
          <!-- Step-by-step instructions -->
          <div class="modal-instructions">
            <ol>
              <li>
              <strong>Select a mode</strong>:
              <ul>
                <li><strong>Prediction</strong>: Predicts a Hi-C plot for a given locus using C.Origami</li>
                <li><strong>Deletion</strong>: Predicts the effect of deleting a region</li>
                <li><strong>Screening</strong>: Calculates an impact score for peaks (requires several minutes)</li>
              </ul>
            </li>
            <li><strong>Select a pre-trained model and genome</strong></li>
            <li>
              <strong>Provide a chromosome and window</strong> up to <em>20 Mb in length</em>. 
              You can also add a second region, which simulates a translocation (i.e. splicing together two loci).
            </li>
            <li>
              <strong>Provide an ATAC and CTCF file.</strong> 
              You may select a pre-normalized file that adheres with the model's requirements, or upload a raw file and check the box to perform normalization.
              If no CTCF file is provided, one will be automatically generated using maxATAC 
              (this requires a <em>raw</em> ATAC file).
            </li>
            <li>
              <strong>Deletion route</strong>: Select a deletion start and width within the bounds of your chosen chromosome window.
            </li>
            <li>
              <strong>Screening route</strong>: Choose a perturbation width to systematically alter peaks. You may provide an optional peaks file, or generate one automatically. If the latter option is selected, the ATAC bigwig file is first used to generate a bedGraph using UCSCâ€™s bigwigtobedgraph, then MACS2 bdgpeakcall is used to call peaks above a cutoff threshold of 0.5.

              <em>Note: </em> when providing two regions, the screening will be skipped for the first and last 1 Mb of the combined region.
            </li>
            <li>
              <strong>Generate your plots!</strong> The process can take a few minutes, especially for large regions 
              or screening mode, so please be patient.
            </li>
          </ol>
        </div>
        </div>
      </div>
      
      <form id="corigami-form" method="post" action="/" enctype="multipart/form-data">
        <input type="hidden" id="output_dir" value="{{ user_output_folder }}">
        <input type="hidden" id="chimeric_active" name="chimeric_active" value="false">
        <!-- Deletion/Screening Toggle -->
        <div class="row">
          <div class="col-full">
            <div class="switch ds-toggle">
              <input id="ds_none" name="ds_option" type="radio" value="none" class="switch-input" required
                     {% if request.form.ds_option == 'none' or not request.form.ds_option %}checked{% endif %}>
              <label for="ds_none" class="switch-label">Prediction</label>
              <input id="ds_deletion" name="ds_option" type="radio" value="deletion" class="switch-input" required
                     {% if request.form.ds_option == 'deletion' %}checked{% endif %}>
              <label for="ds_deletion" class="switch-label">Deletion</label>
              <input id="ds_screening" name="ds_option" type="radio" value="screening" class="switch-input" required
                     {% if request.form.ds_option == 'screening' %}checked{% endif %}>
              <label for="ds_screening" class="switch-label">Screening</label>
              <span class="switch-selector"></span>
            </div>
          </div>
        </div>
        <div class="global-error-module" id="global-error-module"></div>
        <!-- Combined Model & Genome Row -->
        <div class="row">
          <div class="col-half">
            <label for="model_select" class="small-label">Pretrained model*:</label>
            <select id="model_select" name="model_select" required>
              <option value="IMR90" {% if request.form.model_select == 'IMR90' %}selected{% endif %}>
                IMR-90
              </option>
              <option value="BALL" {% if request.form.model_select == 'BALL' %}selected{% endif %}>
                B-ALL
              </option>
            </select>
          </div>
          <div class="col-half">
            <label for="genome_select" class="small-label">Genome*:</label>
            <select id="genome_select" name="genome_select" required>
              <option value="hg38" {% if request.form.genome_select == 'hg38' or not request.form.genome_select %}selected{% endif %}>hg38</option>
              <option value="mm10" {% if request.form.genome_select == 'mm10' %}selected{% endif %}>mm10</option>
            </select>
          </div>
        </div>

        <div id="model-requirements" class="model-requirements-box">
          <ul class="model-requirements-list" id="model-requirements-list">
          </ul>
        </div>

        <!-- Region Row with 20/40/40 width distribution -->
        <div class="row">
          <div class="col-20">
            <label for="region_chr1" class="small-label">Chr*</label>
            <select id="region_chr1" name="region_chr1" required>
              <option value="">Loading...</option>
            </select>
          </div>
          <div class="col-40">
            <label for="region_start1" class="small-label">Start (bp)*</label>
            <input type="number" id="region_start1" name="region_start1" value="{{ request.form.region_start1}}" required>
          </div>
          <div class="col-40">
            <label for="region_end1" class="small-label">End (bp)</label>
            <input type="number" id="region_end1" name="region_end1">
          </div>
        </div>
        <!-- Add Second Chromosome Toggle (Plus/X) -->
        <div class="row">
          <div class="add-second-chr-container" id="toggle-second-chr-container">
            <span id="toggle-second-chr" class="toggle-plus">+</span>
            <span class="toggle-plus-label">Add second region</span>
          </div>
        </div>

        <!-- Optional Second Chromosome Fields -->
        <div id="second_chr_fields" style="display:none;">
          <!-- Second Chromosome Inputs -->
          <div class="row">
            <div class="col-20">
              <label for="region_chr2" class="small-label">Chr2*</label>
              <select id="region_chr2" name="region_chr2">
                <option value="">Loading...</option>
              </select>
            </div>
            <div class="col-40">
              <label for="region_start2" class="small-label">Start (bp)*</label>
              <input type="number" id="region_start2" name="region_start2">
            </div>
            <div class="col-40">
              <label for="region_end2" class="small-label">End (bp)</label>
              <input type="number" id="region_end2" name="region_end2">
            </div>
          </div>
          <!-- Orientation Toggles for Reverse/Flip -->
          <div class="row orientation-toggles">
            <!-- First Chromosome Orientation -->
            <div class="col-half">
              <fieldset class="yesNo">
                <legend>First region</legend>
                <span class="radioButton radioButton__false">
                  <input type="checkbox" id="first_reverse" name="first_reverse" value="true" />
                  <label for="first_reverse">Reverse</label>
                </span>
                <span class="radioButton radioButton__true">
                  <input type="checkbox" id="first_flip" name="first_flip" value="true" />
                  <label for="first_flip">Flip</label>
                </span>
              </fieldset>
            </div>
            <!-- Second Chromosome Orientation -->
            <div class="col-half">
              <fieldset class="yesNo">
                <legend>Second region</legend>
                <span class="radioButton radioButton__false">
                  <input type="checkbox" id="second_reverse" name="second_reverse" value="true" />
                  <label for="second_reverse">Reverse</label>
                </span>
                <span class="radioButton radioButton__true">
                  <input type="checkbox" id="second_flip" name="second_flip" value="true" />
                  <label for="second_flip">Flip</label>
                </span>
              </fieldset>
            </div>
          </div>
        </div>

        <!-- ATACâ€‘seq BigWig File -->
        <div class="row file-input-container atac-input-container">
          <div class="col-full">
            <label for="atac_bw_path" class="small-label">ATACâ€‘seq BigWig File*:</label>
            <div class="file-upload-group">
              <select id="atac_bw_path" name="atac_bw_path" required>
                <option value="./corigami_data/data/hg38/imr90/genomic_features/atac.bw" selected data-model="IMR90">IMR-90 Preset (raw)</option>
                <option value="./corigami_data/data/hg38/ball/MCG023_ATAC_merged_IS_slop20_RP20M_minmax01.bw" data-model="BALL">B-ALL Preset (minmax normalized)</option>
              </select>
              <label class="upload-button" for="atac_bw_file">Upload</label>
            </div>
            <input type="file" id="atac_bw_file" name="atac_bw_file">
          </div>
        </div>
        <!-- ATAC File Normalization -->
        <div class="row">
          <div class="col-full">
            <label for="apply_atac_norm" class="checkbox-container" id="apply_atac_norm_wrapper">
              <input type="checkbox" id="apply_atac_norm" name="apply_atac_norm" value="true" style="display: none;" />
              <span id="apply_atac_norm_label">
                Apply norm to my raw ATAC file
              </span>
            </label>
          </div>
        </div>
        <!-- CTCF BigWig File -->
        <div class="row file-input-container ctcf-input-container">
          <div class="col-full">
            <label for="ctcf_bw_path" class="small-label">CTCF BigWig File:</label>
            <div class="file-upload-group">
              <select id="ctcf_bw_path" name="ctcf_bw_path">
                <option value="none" selected>None (auto-generate)</option>
                <option value="./corigami_data/data/hg38/imr90/genomic_features/ctcf_log2fc.bw" data-model="IMR90">IMR-90 Preset (log2fc normalized)</option>
                <option value="./corigami_data/data/hg38/ball/MCG023_CTCF_merged_maxatac_predict.bw" data-model="BALL">B-ALL Preset (minmax normalized)</option>
              </select>
              <label class="upload-button" for="ctcf_bw_file">Upload</label>
            </div>
            <input type="file" id="ctcf_bw_file" name="ctcf_bw_file">
          </div>
        </div>
        <div class="row" id="predict_ctcf_row">
          <div class="col-full">
            <label for="predict_ctcf" class="checkbox-container" id="predict_ctcf_wrapper">
              <input type="checkbox" id="predict_ctcf" name="predict_ctcf" value="true" style="display: none;" />
              <span id="predict_ctcf_label">
                Automatically generate my CTCF file
              </span>
            </label>
          </div>
        </div>
        <!-- CTCF File Normalization -->
        <div class="row" id="ctcf_norm_row">
          <div class="col-full">
            <label for="apply_ctcf_norm" class="checkbox-container" id="apply_ctcf_norm_wrapper">
              <input type="checkbox" id="apply_ctcf_norm" name="apply_ctcf_norm" value="true" style="display: none;" />
              <span id="apply_ctcf_norm_label">
                Apply norm to my raw CTCF file
              </span>
            </label>
          </div>
        </div>
        <!-- Deletion Parameters -->
        <div id="deletion-fields" class="optional-row" style="display: none;">
          <div class="row">
            <div class="col-half">
              <label for="del_start" class="small-label">Deletion Start (bp):*</label>
              <input type="number" id="del_start" name="del_start" value="{{ request.form.del_start or '1500000' }}">
            </div>
            <div class="col-half">
              <label for="del_width" class="small-label">Deletion Width (bp):*</label>
              <input type="number" id="del_width" name="del_width" value="{{ request.form.del_width or '500000' }}">
            </div>
          </div>
        </div>
        <!-- Peaks File Container (for screening) -->
        <div id="peaks_file_container" class="optional-row" style="display: none;">
          <div class="col-full">
            <label for="peaks_file_path" class="small-label">Peaks File (MACS2 narrowPeak):</label>
            <div class="file-upload-group">
              <select id="peaks_file_path" name="peaks_file_path">
                <option value="none" selected>None (auto-generate)</option>
                <option value="./corigami_data/data/hg38/imr90/genomic_features/MACS2_peaks.narrowPeak.txt" data-model="IMR90">
                  IMR-90 Preset
                </option>
              </select>
              <label class="upload-button" for="peaks_file_upload">Upload</label>
            </div>
            <input type="file" id="peaks_file_upload" name="peaks_file">
          </div>
        </div>
        <!-- Screening Fields -->
        <div id="screening-fields-2" class="optional-row" style="display: none;">
          <div class="row">
            <div class="col-full">
              <label for="perturb_width" class="small-label">Perturbation Width (bp):*</label>
              <input type="number" id="perturb_width" name="perturb_width" value="{{ request.form.perturb_width or '1000' }}">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-full">
            <input type="submit" value="Generate plots" class="submit-button">
          </div>
        </div>
      </form>
      <div id="screening_message" style="color:red;"></div>
    </div>
    <div id="output-container" class="output-container">
      <!-- D3 chart containers -->
      <div id="hi_c_chart"></div>
      <div id="ctcf_chart"></div>
      <div id="atac_chart"></div>
      {% if screening_mode %}
        <div id="screening_chart"></div>
      {% endif %}
    </div>
  </div>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
