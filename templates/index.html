<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>C.Origami Viewer</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

  <!-- External libraries only (no inline JS) -->
  <script src="https://d3js.org/d3.v7.min.js" defer></script>
  <script src="{{ url_for('static', filename='d3_plots.js') }}" defer></script>
  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>

<body data-aws-enabled="{{ 'true' if USE_AWS else 'false' }}">
  <div class="container">
    <div class="form-container">
      <div class="form-header">
        <h1>C.ORIGAMI VIEWER</h1>

        <!-- Header links (HTML-only open via query param) -->
        <p class="instructions-link">
          <a href="/?modal=instructions" id="openModal">Instructions</a>
          <span class="instructions-sep"> | </span>
          <a href="/?modal=bug" id="openBugModal">Report a bug</a>
        </p>

        <button id="worker-btn" class="worker-button status-red">Connect to server</button>
      </div>

      <!-- Unified modal: Instructions / Bug (HTML-only switching via ?modal=...) -->
      <div
        id="instructions-modal"
        class="modal"
        aria-hidden="{{ 'false' if request.args.get('modal') in ['bug','instructions'] else 'true' }}"
        style="{% if request.args.get('modal') in ['bug','instructions'] %}display:block{% else %}display:none{% endif %}"
      >
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
          <span class="close" aria-label="Close">&times;</span>

          <!-- Header -->
          <div class="modal-header">
            <div class="modal-title" id="modal-title">
                C.Origami Viewer
            </div>
          </div>

          <!-- Body: INSTRUCTIONS -->
          <div
            id="instructions-body"
            class="modal-body"
            data-modal-section="instructions"
          >
            <div class="modal-section">
              <h4>1. Select from the following modes:</h4>
              <ul class="modal-list">
                <li><strong>Prediction</strong>: Generate cell-type-specific contact maps for regions up to 20 Mb.</li>
                <li><strong>Deletion</strong>: Remove a region to assess domain merging and insulation changes.</li>
                <li><strong>Screening</strong>: Calculate an impact score for perturbations at ATAC-seq peaks by systematically deleting small segments.</li>
              </ul>
            </div>

            <div class="modal-section">
              <h4>2. Model &amp; genome</h4>
              <p>Select an available pre-trained model and genome.</p>
            </div>

            <div class="modal-section">
              <h4>3. Region</h4>
              <p>
                Provide a chromosome and window up to <strong>20 Mb</strong>.
                Click “+” to add a second region for <strong>translocation analysis.</strong>
                (simulates fusion of two genomic regions).
              </p>
            </div>

            <div class="modal-section">
              <h4>4. ATAC &amp; CTCF</h4>
              <ul class="modal-list">
                <li>Use model presets or upload your own bigWig files.</li>
                <li>If you provide raw files, please check the box to normalize the files as per the model's requirements.</li>
                <li>If you do not have a CTCF file, one can be generated from ATAC using maxATAC.</li>
              </ul>
            </div>

            <div class="modal-section">
              <h4>5. Deletion</h4>
              <p>Select a <strong>deletion start</strong> and <strong>width</strong> within your window.</p>
            </div>

            <div class="modal-section">
              <h4>6. Screening</h4>
              <ul class="modal-list">
                <li>Set <strong>perturbation width</strong> (default: <strong>1 kb</strong>).</li>
                <li>Upload a peaks file or auto-generate from ATAC using MACS2.</li>
                <li><em>Note:</em> screening skips the first and last 1 Mb of each chromosome.</li>
              </ul>
            </div>
          </div>

          <!-- Body: BUG -->
          <div
            id="bug-body"
            class="modal-body"
            data-modal-section="bug"
          >
            <div class="modal-section">
              <iframe
                id="bug-form"
                src="https://docs.google.com/forms/d/e/1FAIpQLSeHtQStAeWxW3lrV7OyKz0VdKWpHMeMYVqShugTRcoSwzYAIQ/viewform?embedded=true"
                loading="lazy"
                title="Bug report form">
              </iframe>
              <p style="margin-top:8px;font-size:0.9em;">
                Can’t see the form?
                <a
                  href="https://docs.google.com/forms/d/e/1FAIpQLSeHtQStAeWxW3lrV7OyKz0VdKWpHMeMYVqShugTRcoSwzYAIQ/viewform"
                  target="_blank" rel="noopener">Open it in a new tab</a>.
              </p>
            </div>
          </div>

          <!-- Footer -->
          <div class="modal-footer">
            For more information on C.Origami,
            <a href="https://www.nature.com/articles/s41587-022-01612-8" target="_blank" rel="noopener">read the paper</a>
            or visit the
            <a href="https://github.com/tanjimin/C.Origami" target="_blank" rel="noopener">GitHub repository</a>.
          </div>
        </div>
      </div>

      <!-- Main form -->
      <form id="corigami-form" method="post" action="/?plot=true" enctype="multipart/form-data">
        <input type="hidden" id="output_dir" value="{{ user_output_folder }}" />
        <input type="hidden" id="chimeric_active" name="chimeric_active" value="false" />

        <!-- Mode switch -->
        <div class="row">
          <div class="col-full">
            <div class="switch ds-toggle">
              <input id="ds_none" name="ds_option" type="radio" value="none" class="switch-input" required
                     {% if request.form.ds_option == 'none' or not request.form.ds_option %}checked{% endif %} />
              <label for="ds_none" class="switch-label">Prediction</label>

              <input id="ds_deletion" name="ds_option" type="radio" value="deletion" class="switch-input" required
                     {% if request.form.ds_option == 'deletion' %}checked{% endif %} />
              <label for="ds_deletion" class="switch-label">Deletion</label>

              <input id="ds_screening" name="ds_option" type="radio" value="screening" class="switch-input" required
                     {% if request.form.ds_option == 'screening' %}checked{% endif %} />
              <label for="ds_screening" class="switch-label">Screening</label>

              <span class="switch-selector"></span>
            </div>
          </div>
        </div>

        <!-- Global error module -->
        <div class="global-error-module" id="global-error-module"></div>

        <!-- Model & Genome -->
        <div class="row">
          <div class="col-half">
            <label for="model_select" class="small-label">Pretrained model*:</label>
            <select id="model_select" name="model_select" required>
              <option value="IMR90" {% if request.form.model_select == 'IMR90' %}selected{% endif %}>IMR-90</option>
              <option value="BALL"  {% if request.form.model_select == 'BALL'  %}selected{% endif %}>B-ALL</option>
            </select>
          </div>
          <div class="col-half">
            <label for="genome_select" class="small-label">Genome*:</label>
            <select id="genome_select" name="genome_select" required>
              <option value="hg38" {% if request.form.genome_select == 'hg38' or not request.form.genome_select %}selected{% endif %}>hg38</option>
              <option value="mm10" {% if request.form.genome_select == 'mm10' %}selected{% endif %}>mm10</option>
            </select>
          </div>
        </div>

        <!-- Model requirements box -->
        <div id="model-requirements" class="model-requirements-box">
          <ul class="model-requirements-list" id="model-requirements-list"></ul>
        </div>

        <!-- Region 1 -->
        <div class="row">
          <div class="col-20">
            <label for="region_chr1" class="small-label">Chr*</label>
            <select id="region_chr1" name="region_chr1" required>
              <option value="">Loading...</option>
            </select>
          </div>
          <div class="col-40">
            <label for="region_start1" class="small-label">Start (bp)*</label>
            <input type="number" id="region_start1" name="region_start1"
                   value="{{ request.form.region_start1|default(2097153, true) }}" required />
          </div>
          <div class="col-40">
            <label for="region_end1" class="small-label">End (bp)</label>
            <input type="number" id="region_end1" name="region_end1" />
          </div>
        </div>

        <!-- Add second region toggle -->
        <div class="row">
          <div class="add-second-chr-container" id="toggle-second-chr-container">
            <span id="toggle-second-chr" class="toggle-plus" aria-hidden="true">+</span>
            <span class="toggle-plus-label">Add second region</span>
          </div>
        </div>

        <!-- Region 2 (optional) -->
        <div id="second_chr_fields" style="display:none;">
          <div class="row">
            <div class="col-20">
              <label for="region_chr2" class="small-label">Chr2*</label>
              <select id="region_chr2" name="region_chr2">
                <option value="">Loading...</option>
              </select>
            </div>
            <div class="col-40">
              <label for="region_start2" class="small-label">Start (bp)*</label>
              <input type="number" id="region_start2" name="region_start2" />
            </div>
            <div class="col-40">
              <label for="region_end2" class="small-label">End (bp)</label>
              <input type="number" id="region_end2" name="region_end2" />
            </div>
          </div>

          <!-- Orientation toggles -->
          <div class="row orientation-toggles">
            <div class="col-half">
              <fieldset class="yesNo">
                <legend>First region</legend>
                <span class="radioButton radioButton__false">
                  <input type="checkbox" id="first_reverse" name="first_reverse" value="true" />
                  <label for="first_reverse">Reverse</label>
                </span>
                <span class="radioButton radioButton__true">
                  <input type="checkbox" id="first_flip" name="first_flip" value="true" />
                  <label for="first_flip">Flip</label>
                </span>
              </fieldset>
            </div>
            <div class="col-half">
              <fieldset class="yesNo">
                <legend>Second region</legend>
                <span class="radioButton radioButton__false">
                  <input type="checkbox" id="second_reverse" name="second_reverse" value="true" />
                  <label for="second_reverse">Reverse</label>
                </span>
                <span class="radioButton radioButton__true">
                  <input type="checkbox" id="second_flip" name="second_flip" value="true" />
                  <label for="second_flip">Flip</label>
                </span>
              </fieldset>
            </div>
          </div>
        </div>

        <!-- ATAC -->
        <div class="row file-input-container atac-input-container">
          <div class="col-full">
            <label for="atac_bw_path" class="small-label">ATAC-seq BigWig File*:</label>
            <div class="file-upload-group">
              <select id="atac_bw_path" name="atac_bw_path" required>
                <option value="./corigami_data/data/hg38/imr90/genomic_features/atac.bw" selected data-model="IMR90">
                  IMR-90 Preset (raw)
                </option>
                <option value="./corigami_data/data/hg38/ball/MCG023_ATAC_merged_IS_slop20_RP20M_minmax01.bw" data-model="BALL">
                  B-ALL Preset (minmax normalized)
                </option>
              </select>
              <label class="upload-button" for="atac_bw_file">Upload</label>
            </div>
            <input type="file" id="atac_bw_file" name="atac_bw_file" />
          </div>
        </div>

        <!-- ATAC normalization -->
        <div class="row">
          <div class="col-full">
            <label for="apply_atac_norm" class="checkbox-container" id="apply_atac_norm_wrapper">
              <input type="checkbox" id="apply_atac_norm" name="apply_atac_norm" value="true" checked style="display:none;" />
              <span id="apply_atac_norm_label">Apply norm to my raw ATAC file</span>
            </label>
          </div>
        </div>

        <!-- CTCF -->
        <div class="row file-input-container ctcf-input-container">
          <div class="col-full">
            <label for="ctcf_bw_path" class="small-label">CTCF BigWig File:</label>
            <div class="file-upload-group">
              <select id="ctcf_bw_path" name="ctcf_bw_path">
                <option value="none" selected>None (auto-generate)</option>
                <option value="./corigami_data/data/hg38/imr90/genomic_features/ctcf_log2fc.bw" data-model="IMR90">
                  IMR-90 Preset (log2fc normalized)
                </option>
                <option value="./corigami_data/data/hg38/ball/MCG023_CTCF_merged_maxatac_predict.bw" data-model="BALL">
                  B-ALL Preset (minmax normalized)
                </option>
              </select>
              <label class="upload-button" for="ctcf_bw_file">Upload</label>
            </div>
            <input type="file" id="ctcf_bw_file" name="ctcf_bw_file" />
          </div>
        </div>

        <!-- Predict CTCF from ATAC -->
        <div class="row" id="predict_ctcf_row">
          <div class="col-full">
            <label for="predict_ctcf" class="checkbox-container" id="predict_ctcf_wrapper">
              <input type="checkbox" id="predict_ctcf" name="predict_ctcf" value="true" style="display:none;" />
              <span id="predict_ctcf_label">Automatically generate my CTCF file</span>
            </label>
          </div>
        </div>

        <!-- CTCF normalization -->
        <div class="row" id="ctcf_norm_row">
          <div class="col-full">
            <label for="apply_ctcf_norm" class="checkbox-container" id="apply_ctcf_norm_wrapper">
              <input type="checkbox" id="apply_ctcf_norm" name="apply_ctcf_norm" value="true" style="display:none;" />
              <span id="apply_ctcf_norm_label">Apply norm to my raw CTCF file</span>
            </label>
          </div>
        </div>

        <!-- Deletion parameters -->
        <div id="deletion-fields" class="optional-row" style="display:none;">
          <div class="row">
            <div class="col-half">
              <label for="del_start" class="small-label">Deletion Start (bp):*</label>
              <input type="number" id="del_start" name="del_start" value="{{ request.form.del_start or '1500000' }}" />
            </div>
            <div class="col-half">
              <label for="del_width" class="small-label">Deletion Width (bp):*</label>
              <input type="number" id="del_width" name="del_width" value="{{ request.form.del_width or '500000' }}" />
            </div>
          </div>
        </div>

        <!-- Peaks (screening) -->
        <div id="peaks_file_container" class="optional-row" style="display:none;">
          <div class="col-full">
            <label for="peaks_file_path" class="small-label">Peaks File (MACS2 narrowPeak):</label>
            <div class="file-upload-group">
              <select id="peaks_file_path" name="peaks_file_path">
                <option value="none" selected>None (auto-generate)</option>
                <option value="./corigami_data/data/hg38/imr90/genomic_features/MACS2_peaks.narrowPeak.txt" data-model="IMR90">
                  IMR-90 Preset
                </option>
              </select>
              <label class="upload-button" for="peaks_file_upload">Upload</label>
            </div>
            <input type="file" id="peaks_file_upload" name="peaks_file" />
          </div>
        </div>

        <!-- Screening parameters -->
        <div id="screening-fields-2" class="optional-row" style="display:none;">
          <div class="row">
            <div class="col-full">
              <label for="perturb_width" class="small-label">Perturbation Width (bp):*</label>
              <input type="number" id="perturb_width" name="perturb_width" value="{{ request.form.perturb_width or '1000' }}" />
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="row">
          <div class="col-full">
            <input type="submit" value="Generate plots" class="submit-button" />
          </div>
        </div>
      </form>

      <div id="screening_message" style="color:red;"></div>
    </div>

    <!-- Output -->
    <div id="output-container" class="output-container">
      <div id="hi_c_chart"></div>
      <div id="ctcf_chart"></div>
      <div id="atac_chart"></div>
      {% if screening_mode %}
        <div id="screening_chart"></div>
      {% endif %}
    </div>
  </div>
</body>
</html>
