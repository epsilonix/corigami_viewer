<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>C.Origami Viewer</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  {% if screening_mode %}
    <script>
      var screening_mode = true;
      var screening_params = {{ screening_params|safe }};
    </script>
  {% else %}
    <script>
      var screening_mode = false;
    </script>
  {% endif %}
  <!-- Load D3.js and our custom plotting script -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="{{ url_for('static', filename='d3_plots.js') }}"></script>
  <style>
    input[readonly] {
      background-color: #e0e0e0;
      color: #555;
      cursor: not-allowed;
    }
  </style>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

</head>
<body>
  <div class="container">
    <div class="form-container">
      <div class="form-header">
        <h1>C.ORIGAMI VIEWER</h1>
        <p class="instructions-link"><a href="#" id="openModal">Instructions</a></p>
      </div>
      <div id="instructions-modal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2>Instructions</h2>
          <p>
            When uploading files, please indicate the current normalization state of your ATAC and CTCF files.
            If you do not provide a CTCF file, a raw ATAC file is required, and the CTCF signal will be generated automatically using maxATAC.
          </p>
        </div>
      </div>
      <form id="corigami-form" method="post" action="/" enctype="multipart/form-data">
        <input type="hidden" id="output_dir" value="{{ user_output_folder }}">
        <input type="hidden" id="chimeric_active" name="chimeric_active" value="false">
        <!-- Deletion/Screening Toggle -->
        <div class="row">
          <div class="col-full">
            <div class="switch ds-toggle">
              <input id="ds_none" name="ds_option" type="radio" value="none" class="switch-input" required
                     {% if request.form.ds_option == 'none' or not request.form.ds_option %}checked{% endif %}>
              <label for="ds_none" class="switch-label">Prediction</label>
              <input id="ds_deletion" name="ds_option" type="radio" value="deletion" class="switch-input" required
                     {% if request.form.ds_option == 'deletion' %}checked{% endif %}>
              <label for="ds_deletion" class="switch-label">Deletion</label>
              <input id="ds_screening" name="ds_option" type="radio" value="screening" class="switch-input" required
                     {% if request.form.ds_option == 'screening' %}checked{% endif %}>
              <label for="ds_screening" class="switch-label">Screening</label>
              <span class="switch-selector"></span>
            </div>
          </div>
        </div>
        <div class="global-error-module" id="global-error-module"></div>
        <!-- Combined Model & Genome Row -->
        <div class="row">
          <div class="col-half">
            <label for="model_select" class="small-label">Model*:</label>
            <select id="model_select" name="model_select" required>
              <option value="V1" {% if request.form.model_select == 'V1' %}selected{% endif %}>
                V1 (Jimin's model, uses log norm)
              </option>
              <option value="V2" {% if request.form.model_select == 'V2' %}selected{% endif %}>
                V2 (Javier's model, uses minmax norm)
              </option>
              <option value="V3" {% if request.form.model_select == 'V3' %}selected{% endif %}>
                V3 (Romane's model, uses log norm)
              </option>
              <option value="V4" {% if request.form.model_select == 'V4' %}selected{% endif %}>
                V4 (Javier's new model)
              </option>
            </select>
          </div>
          <div class="col-half">
            <label for="genome_select" class="small-label">Genome*:</label>
            <select id="genome_select" name="genome_select" required>
              <option value="hg38" {% if request.form.genome_select == 'hg38' or not request.form.genome_select %}selected{% endif %}>hg38</option>
              <option value="mm10" {% if request.form.genome_select == 'mm10' %}selected{% endif %}>mm10</option>
            </select>
          </div>
        </div>

        <!-- Region Row with 20/40/40 width distribution -->
        <div class="row">
          <div class="col-20">
            <label for="region_chr1" class="small-label">Chr*</label>
            <select id="region_chr1" name="region_chr1" required>
              <option value="">Loading...</option>
            </select>
          </div>
          <div class="col-40">
            <label for="region_start1" class="small-label">Start (bp)*</label>
            <input type="number" id="region_start1" name="region_start1" value="{{ request.form.region_start1}}" required>
          </div>
          <div class="col-40">
            <label for="region_end1" class="small-label">End (bp)</label>
            <input type="number" id="region_end1" name="region_end1">
          </div>
        </div>
        <!-- Add Second Chromosome Toggle (Plus/X) -->
        <div class="row">
          <div class="add-second-chr-container" id="toggle-second-chr-container">
            <span id="toggle-second-chr" class="toggle-plus">+</span>
            <span class="toggle-plus-label">Add second region</span>
          </div>
        </div>

        <!-- Optional Second Chromosome Fields -->
        <div id="second_chr_fields" style="display:none;">
          <!-- Second Chromosome Inputs -->
          <div class="row">
            <div class="col-20">
              <label for="region_chr2" class="small-label">Chr2*</label>
              <select id="region_chr2" name="region_chr2">
                <option value="">Loading...</option>
              </select>
            </div>
            <div class="col-40">
              <label for="region_start2" class="small-label">Start (bp)*</label>
              <input type="number" id="region_start2" name="region_start2">
            </div>
            <div class="col-40">
              <label for="region_end2" class="small-label">End (bp)</label>
              <input type="number" id="region_end2" name="region_end2">
            </div>
          </div>
          <!-- Orientation Toggles for Reverse/Flip -->
          <div class="row orientation-toggles">
            <!-- First Chromosome Orientation -->
            <div class="col-half">
              <fieldset class="yesNo">
                <legend>First region</legend>
                <span class="radioButton radioButton__false">
                  <input type="checkbox" id="first_reverse" name="first_orientation" value="reverse" />
                  <label for="first_reverse">Reverse</label>
                </span>
                <span class="radioButton radioButton__true">
                  <input type="checkbox" id="first_flip" name="first_orientation" value="flip" />
                  <label for="first_flip">Flip</label>
                </span>
              </fieldset>
            </div>
            <!-- Second Chromosome Orientation -->
            <div class="col-half">
              <fieldset class="yesNo">
                <legend>Second region</legend>
                <span class="radioButton radioButton__false">
                  <input type="checkbox" id="second_reverse" name="second_orientation" value="reverse" />
                  <label for="second_reverse">Reverse</label>
                </span>
                <span class="radioButton radioButton__true">
                  <input type="checkbox" id="second_flip" name="second_orientation" value="flip" />
                  <label for="second_flip">Flip</label>
                </span>
              </fieldset>
            </div>
          </div>
        </div>

        <!-- ATAC‑seq BigWig File -->
        <div class="row file-input-container atac-input-container">
          <div class="col-full">
            <label for="atac_bw_path" class="small-label">ATAC‑seq BigWig File*:</label>
            <div class="file-upload-group">
              <select id="atac_bw_path" name="atac_bw_path" required>
                <option value="./corigami_data/data/hg38/imr90/genomic_features/atac.bw" selected>Preset (hg38/imr90)</option>
              </select>
              <label class="upload-button" for="atac_bw_file">Upload</label>
            </div>
            <input type="file" id="atac_bw_file" name="atac_bw_file">
          </div>
        </div>
        <!-- ATAC File Normalization -->
        <div class="row">
          <div class="col-full">
            <div class="switch norm-toggle" id="atac-switch">
              <input id="atac-no-norm" name="norm_atac" type="radio" value="none" class="switch-input" {% if request.form.norm_atac == 'none' or not request.form.norm_atac %}checked{% endif %}>
              <label for="atac-no-norm" class="switch-label">raw</label>
              <input id="atac-log" name="norm_atac" type="radio" value="log" class="switch-input" {% if request.form.norm_atac == 'log' %}checked{% endif %}>
              <label for="atac-log" class="switch-label">log</label>
              <input id="atac-minmax" name="norm_atac" type="radio" value="minmax" class="switch-input" {% if request.form.norm_atac == 'minmax' %}checked{% endif %}>
              <label for="atac-minmax" class="switch-label">minmax</label>
              <span class="switch-selector"></span>
            </div>
          </div>
        </div>
        <!-- CTCF BigWig File -->
        <div class="row file-input-container ctcf-input-container">
          <div class="col-full">
            <label for="ctcf_bw_path" class="small-label">CTCF BigWig File:</label>
            <div class="file-upload-group">
              <select id="ctcf_bw_path" name="ctcf_bw_path">
                <option value="none" selected>None</option>
                <option value="./corigami_data/data/hg38/imr90/genomic_features/ctcf_log2fc.bw">Preset (hg38/imr90, log norm)</option>
              </select>
              <label class="upload-button" for="ctcf_bw_file">Upload</label>
            </div>
            <input type="file" id="ctcf_bw_file" name="ctcf_bw_file">
          </div>
        </div>
        <!-- CTCF File Normalization -->
        <div class="row">
          <div class="col-full">
            <div class="switch norm-toggle" id="ctcf-switch">
              <input id="ctcf-no-norm" name="norm_ctcf" type="radio" value="none" class="switch-input" checked>
              <label for="ctcf-no-norm" class="switch-label">raw</label>
              <input id="ctcf-log" name="norm_ctcf" type="radio" value="log" class="switch-input" {% if request.form.norm_ctcf == 'log' %}checked{% endif %}>
              <label for="ctcf-log" class="switch-label">log</label>
              <input id="ctcf-minmax" name="norm_ctcf" type="radio" value="minmax" class="switch-input" {% if request.form.norm_ctcf == 'minmax' %}checked{% endif %}>
              <label for="ctcf-minmax" class="switch-label">minmax</label>
              <span class="switch-selector"></span>
            </div>
          </div>
        </div>
        <!-- Training Normalization -->
        <div class="row" id="training-norm-container">
          <div class="col-full">
            <label class="small-label">Select normalization method for training*:</label>
            <div class="switch norm-toggle" id="training-norm-switch">
              <input id="training-log" name="training_norm" type="radio" value="log" class="switch-input">
              <label for="training-log" class="switch-label">log</label>
              <input id="training-minmax" name="training_norm" type="radio" value="minmax" class="switch-input" checked>
              <label for="training-minmax" class="switch-label">minmax</label>
              <span class="switch-selector"></span>
            </div>
          </div>
        </div>
        <hr class="separator">
        <!-- Deletion Parameters -->
        <div id="deletion-fields" class="optional-row" style="display: none;">
          <div class="row">
            <div class="col-half">
              <label for="del_start" class="small-label">Deletion Start (bp):*</label>
              <input type="number" id="del_start" name="del_start" value="{{ request.form.del_start or '1500000' }}">
            </div>
            <div class="col-half">
              <label for="del_width" class="small-label">Deletion Width (bp):*</label>
              <input type="number" id="del_width" name="del_width" value="{{ request.form.del_width or '500000' }}">
            </div>
          </div>
        </div>
        <!-- Peaks File Container (for screening) -->
        <div id="peaks_file_container" class="optional-row" style="display: none;">
          <div class="col-full">
            <label for="peaks_file_path" class="small-label">Peaks File (MACS2 narrowPeak):</label>
            <div class="file-upload-group">
              <select id="peaks_file_path" name="peaks_file_path">
                <option value="none" selected>None</option>
                <option value="./corigami_data/data/hg38/imr90/genomic_features/MACS2_peaks.narrowPeak.txt">
                  Preset (hg38/imr90)
                </option>
              </select>
              <label class="upload-button" for="peaks_file_upload">Upload</label>
            </div>
            <input type="file" id="peaks_file_upload" name="peaks_file">
          </div>
        </div>
        <!-- Screening Fields -->
        <div id="screening-fields-2" class="optional-row" style="display: none;">
          <div class="row">
            <div class="col-half">
              <label for="perturb_width" class="small-label">Perturb Width (bp):*</label>
              <input type="number" id="perturb_width" name="perturb_width" value="{{ request.form.perturb_width or '1000' }}">
            </div>
            <div class="col-half">
              <label for="step_size" class="small-label">Step Size (bp):*</label>
              <input type="number" id="step_size" name="step_size" value="{{ request.form.step_size or '1000' }}">
            </div>
          </div>
        </div>
        <input type="submit" value="Generate plots" class="submit-button">
      </form>
      <div id="screening_message" style="color:red;"></div>
    </div>
    <div id="output-container" class="output-container">
      <!-- D3 chart containers -->
      <div id="hi_c_chart"></div>
      <div id="ctcf_chart"></div>
      <div id="atac_chart"></div>
      {% if screening_mode %}
        <div id="screening_chart"></div>
      {% endif %}
    </div>
  </div>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
  <script>
    // Render D3 plots using configuration objects passed from the server
    var hiCConfig = {{ hi_c_config|safe }};
    var ctcfConfig = {{ ctcf_config|safe }};
    var atacConfig = {{ atac_config|safe }};
    drawHiCChart('#hi_c_chart', hiCConfig);
    drawLineChart('#ctcf_chart', ctcfConfig);
    drawLineChart('#atac_chart', atacConfig);
    {% if screening_mode and screening_config %}
      var screeningConfig = {{ screening_config|safe }};
      drawColumnChart('#screening_chart', screeningConfig);
    {% endif %}
  </script>
</body>
</html>
